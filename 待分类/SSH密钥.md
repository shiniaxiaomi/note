# SSH密钥

## 公钥私钥简介

公钥和私钥都属于非对称加密算法的一个实现，这个加密算法的信息交换过程是这样的：

1. 持有公钥的一方（甲）在收到持有私钥的一方（乙）的请求时，甲会在自己的公钥列表中查找是否有乙的公钥，如果有，则将一个随机的字符串使用乙的公钥加密后并发送给乙
2. 乙收到加密的字符串后，使用自己的私钥进行解密，并将解密后的字符串返回给甲
3. 甲收到乙解密后的字符串后与随机生成的字符串进行比对，如果相同，则验证通过，否则验证失败

注意：非对称加密是指信息使用公钥加密后，可以使用私钥进行解密，而公钥和私钥是不相同的；非对称加密算法不能使用相同的密钥进行解密，即公钥加密后不能通过公钥解密，私钥也是如此。

## 如何通过SSH密钥进行免密登入

通过SSH密钥登入认证即在通过SSH连接远程服务器时，我们一般都是需要输入密码进行验证后才能够登入到远程服务器，但是通过SSH密码登入认证，我们就无需密码即可登入



配置SSH密钥步骤：

1. 找到我们用户目录下的`~/.ssh`文件夹，公钥和私钥都会存在该文件夹下

   ```shell
   $ cd .ssh/
   $ ls
   id_rsa		id_rsa.pub	known_hosts
   ```

   经过查看，我们可以看到该文件夹下会存在三个文件，`id_rsa`文件是我们自己电脑的私钥,`id_rsa.pub`文件是我们自己电脑的私钥

2. 如果没有该`.ssh`文件夹，需要手动创建一个；如果没有该`.ssh`文件夹下的`id_rsa.pub`公钥和`id_rsa`私钥，可以通过以下命令进行创建

   ```shell
   $ cd .ssh/
   $ ssh-keygen
   ```

   > 输入命令后，一路回车即可

   创建成功后，该文件夹下就会生成公钥和私钥

3. 将我们的公钥复制到远程服务器上

   - 方式一：

     ```shell
     $ ssh-copy-id -i ~/.ssh/id_rsa.pub root@xxx.xxx.xxx.xxx
     ```

     > `xxx.xxx.xxx.xxx`为你远程服务器的ip

     执行该命令后，会自动在远程服务器的公钥文件内容中追加我们生成的公钥内容（即在远程服务器的`~/.ssh/authorized_keys`文件下追加）。这个过程是全自动的，非常方便

   - 方式二：

     自己拷贝你的公钥追加到远程服务器上的`~/.ssh/authorized_keys`文件中（如果远程服务器没有该文件就自己创建一个，创建后需要将`.ssh`文件夹的权限设置为777，需要执行`chmod 777 ~/.ssh`）

4. 这样操作之后就可以直接免密登入远程服务器了

   如果还是不行，就要检查远程服务器的`/etc/ssh/sshd_config`文件，检查下面几行前面，取消掉他们的注释即可

   ```shell
   RSAAuthentication yes   
   PubkeyAuthentication yes   
   AuthorizedKeysFile .ssh/authorized_keys
   ```

   取消掉之后需要重启远程服务器的ssh服务：

   - CenterOS：使用`service sshd restart`命令重启
   - Ubuntu：使用`sudo /etc/init.d/ssh restart`命令重启

## SSH使用密钥免密登入的原理

密钥验证的前提需要登陆主机生成一对密钥（公钥和私钥），并将公钥放置在服务器上

![1586336-20190213210725731-973454197](/Users/yingjie.lu/Documents/note/.img/1586336-20190213210725731-973454197.png)

前提：我们自己的电脑生成了公钥和私钥，将公钥放入远程服务器保存

1. 我们的电脑发起ssh请求连接远程服务器，此时会将本地电脑的公钥发送给远程服务器
2. 远程服务器会根据收到的公钥寻找自己的列表中是否存在相同的公钥，如果存在，则随机生成一个字符串，并使用公钥进行加密，将加密后的数据发回本地电脑
3. 本地电脑收到加密后的数据后通过私钥解密，将解密后的字符串返回给远程服务器
4. 远程服务器接受到字符串后，跟原先生成的字符串做比对，如果一样，则验证通过，建立连接

> 解密后的字符串即使是明文传输也没有关系，因为该字符串随机生成且只是此次判断的依据，如果被黑客劫持也不会有安全问题产生

## SSH使用密码登入的原理

![1586336-20190213210715597-629546872](/Users/yingjie.lu/Documents/note/.img/1586336-20190213210715597-629546872.png)



1. 本地电脑发起ssh请求连接远程服务器
2. 远程服务器中存在公钥和私钥，那么远程服务器就将公钥返回给本地电脑
3. 本地电脑收到公钥后，将我们输入的登入密码进行加密，将加密后的数据返回给远程服务器
4. 远程服务器收到公钥加密后的密码后，通过私钥解密出登入密码，如果验证通过，则建立连接

> 注意：
>
> - 使用密码登入时，公钥和私钥都是远程服务器所持有的
>
> - 如果在过程中黑客劫持了公钥和公钥加密后的登入密码，也是无法破解的，因为只有私钥才能够解密，但是私钥只存在远程服务器中，这样就保证了信息安全

## 解决SSH过一段时间后自动断线的问题

1. 方法一：客户端向服务端发送心跳包

   步骤：

   - 在本地电脑中编辑ssh_config文件

     ```shell
     sudo vim ~/ssh/ssh_config
     ```

   - 添加一下代码

     ```shell
     ServerAliveInterval 60
     ```

     > 意思是客户端每隔60秒就向服务器端发送一个心跳包来维持连接

2. 方法二：服务端向客户端发送心跳包

   步骤：

   - 在服务器端编辑ssh_config文件

     ```shell
     sudo vim ~/ssh/sshd_config
     ```

   - 添加一下代码

     ```shell
     ClientAliveInterval 60
     ```

     > 意思是服务器端每隔60秒就向客户端发送一个心跳包来维持连接

